define(["jquery","core/yui"],function(a,b){var c={QBANKLOADING:"div.questionbankloading",ADDQUESTIONLINKS:'.menu [data-action="questionbank"]',ADDTOQUIZCONTAINER:"td.addtoquizaction",PREVIEWCONTAINER:"td.previewaction",SEARCHOPTIONS:"#advancedsearch"},d={PAGE:"addonpage",HEADER:"header"},e={_header:null,_firstCheckbox:null,headerinit:function(){if(this._header=b.one("#qbheadercheckbox"),this._header){this._header.setAttrs({disabled:!1,title:M.util.get_string("selectall","moodle")}),this._header.on("click",this._headerClick,this);var a=this._header.ancestor("table");this._firstCheckbox=a.one("tbody tr td.checkbox input")}},_headerClick:function(){var a=b.one("#categoryquestions").all("[type=checkbox],[type=radio]");this._firstCheckbox.get("checked")?(a.set("checked",!1),this._header.setAttribute("title",M.util.get_string("selectall","moodle"))):(a.set("checked",!0),this._header.setAttribute("title",M.util.get_string("deselectall","moodle"))),this._header.set("checked",!1)}},f=function(){f.superclass.constructor.apply(this,arguments)};return b.extend(f,b.Base,{loadingDiv:"",dialogue:null,addonpage:0,searchRegionInitialised:!1,create_dialogue:function(){var a={headerContent:"",bodyContent:b.one(c.QBANKLOADING),draggable:!0,modal:!0,centered:!0,width:null,visible:!1,postmethod:"form",footerContent:null,extraClasses:["mod_quiz_qbank_dialogue"]};this.dialogue=new M.core.dialogue(a),this.dialogue.bodyNode.delegate("click",this.link_clicked,"a[href]",this),this.dialogue.hide(),this.loadingDiv=this.dialogue.bodyNode.getHTML(),b.later(100,this,function(){this.load_content(window.location.search)})},initializer:function(){b.one(c.QBANKLOADING)&&(this.create_dialogue(),b.one("body").delegate("click",this.display_dialogue,c.ADDQUESTIONLINKS,this))},display_dialogue:function(a){a.preventDefault(),this.dialogue.set("headerContent",a.currentTarget.getData(d.HEADER)),this.addonpage=a.currentTarget.getData(d.PAGE);var b=this.dialogue.bodyNode.one(".modulespecificbuttonscontainer");if(b){var c=b.one("input[name=addonpage]");c||(c=b.appendChild('<input type="hidden" name="addonpage">')),c.set("value",this.addonpage)}this.initialiseSearchRegion(),this.dialogue.show()},load_content:function(a){b.log("Starting load.","debug","moodle-mod_quiz-quizquestionbank"),this.dialogue.bodyNode.append(this.loadingDiv),window.history.replaceState&&window.history.replaceState(null,"",M.cfg.wwwroot+"/mod/quiz/edit.php"+a),b.io(M.cfg.wwwroot+"/mod/quiz/questionbank.ajax.php"+a,{method:"GET",on:{success:this.load_done,failure:this.load_failed},context:this}),b.log("Load request sent.","debug","moodle-mod_quiz-quizquestionbank")},load_done:function(a,c){M.mod_quiz=M.mod_quiz||{},M.mod_quiz.quizquestionbank=M.mod_quiz.quizquestionbank||{};var d=JSON.parse(c.responseText);return d.status&&"OK"===d.status?(b.log("Load completed.","debug","moodle-mod_quiz-quizquestionbank"),this.dialogue.bodyNode.setHTML(d.contents),b.use("moodle-question-chooser",function(){M.question.init_chooser({})}),this.dialogue.bodyNode.one("form").delegate("change",this.options_changed,".searchoptions",this),this.dialogue.visible&&b.later(0,this.dialogue,this.dialogue.centerDialogue),e.headerinit(),this.searchRegionInitialised=!1,this.dialogue.get("visible")&&this.initialiseSearchRegion(),this.dialogue.fire("widget:contentUpdate"),void(this.dialogue.get("visible")&&(this.dialogue.hide(),this.dialogue.show()))):void this.load_failed(a,c)},load_failed:function(){b.log("Load failed.","debug","moodle-mod_quiz-quizquestionbank")},link_clicked:function(a){return a.currentTarget.ancestor(c.ADDTOQUIZCONTAINER)?void a.currentTarget.set("href",a.currentTarget.get("href")+"&addonpage="+this.addonpage):a.currentTarget.ancestor(c.PREVIEWCONTAINER)?void window.openpopup(a,{url:a.currentTarget.get("href"),name:"questionpreview",options:"height=600,width=800,top=0,left=0,menubar=0,location=0,scrollbars,resizable,toolbar,status,directories=0,fullscreen=0,dependent"}):void(a.currentTarget.ancestor(c.SEARCHOPTIONS)||(a.preventDefault(),this.load_content(a.currentTarget.get("search"))))},options_changed:function(a){a.preventDefault(),this.load_content("?"+b.IO.stringify(a.currentTarget.get("form")))},initialiseSearchRegion:function(){this.searchRegionInitialised!==!0&&b.one(c.SEARCHOPTIONS)&&(M.util.init_collapsible_region(b,"advancedsearch","question_bank_advanced_search",M.util.get_string("clicktohideshow","moodle")),this.searchRegionInitialised=!0)}}),{init:function(){return M.mod_quiz=M.mod_quiz||{},M.mod_quiz.quizquestionbank=M.mod_quiz.quizquestionbank||{},new f}}});