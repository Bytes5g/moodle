YUI.add("moodle-atto_image-button",function(e,t){var i={RESPONSIVE:"img-responsive",INPUTALIGNMENT:"atto_image_alignment",INPUTALT:"atto_image_altentry",INPUTHEIGHT:"atto_image_heightentry",INPUTSUBMIT:"atto_image_urlentrysubmit",INPUTURL:"atto_image_urlentry",INPUTSIZE:"atto_image_size",INPUTWIDTH:"atto_image_widthentry",IMAGEALTWARNING:"atto_image_altwarning",IMAGEBROWSER:"openimagebrowser",IMAGEPRESENTATION:"atto_image_presentation",INPUTCONSTRAIN:"atto_image_constrain",INPUTCUSTOMSTYLE:"atto_image_customstyle",IMAGEPREVIEW:"atto_image_preview",IMAGEPREVIEWBOX:"atto_image_preview_box"},n={INPUTURL:"."+i.INPUTURL},a=[{name:"text-top",str:"alignment_top",value:"vertical-align",margin:"0 .5em"},{name:"middle",str:"alignment_middle",value:"vertical-align",margin:"0 .5em"},{name:"text-bottom",str:"alignment_bottom",value:"vertical-align",margin:"0 .5em",isDefault:!0},{name:"left",str:"alignment_left",value:"float",margin:"0 .5em 0 0"},{name:"right",str:"alignment_right",value:"float",margin:"0 0 0 .5em"},{name:"customstyle",str:"customstyle",value:"style"}],s={ISPERCENT:/\d+%/},o="atto_image",l='<form class="atto_form"><label for="{{elementid}}_{{CSS.INPUTURL}}">{{get_string "enterurl" component}}</label><input class="fullwidth {{CSS.INPUTURL}}" type="url" id="{{elementid}}_{{CSS.INPUTURL}}" size="32"/><br/>{{#if showFilepicker}}<button class="{{CSS.IMAGEBROWSER}}" type="button">{{get_string "browserepositories" component}}</button>{{/if}}<div style="display:none" role="alert" class="warning {{CSS.IMAGEALTWARNING}}">{{get_string "presentationoraltrequired" component}}</div><label for="{{elementid}}_{{CSS.INPUTALT}}">{{get_string "enteralt" component}}</label><input class="fullwidth {{CSS.INPUTALT}}" type="text" value="" id="{{elementid}}_{{CSS.INPUTALT}}" size="32"/><br/><input type="checkbox" class="{{CSS.IMAGEPRESENTATION}}" id="{{elementid}}_{{CSS.IMAGEPRESENTATION}}"/><label class="sameline" for="{{elementid}}_{{CSS.IMAGEPRESENTATION}}">{{get_string "presentation" component}}</label><br/><label class="sameline" for="{{elementid}}_{{CSS.INPUTSIZE}}">{{get_string "size" component}}</label><div id="{{elementid}}_{{CSS.INPUTSIZE}}" class="{{CSS.INPUTSIZE}}"><label class="accesshide" for="{{elementid}}_{{CSS.INPUTWIDTH}}">{{get_string "width" component}}</label><input type="text" class="{{CSS.INPUTWIDTH}} input-mini" id="{{elementid}}_{{CSS.INPUTWIDTH}}" size="4"/> x <label class="accesshide" for="{{elementid}}_{{CSS.INPUTHEIGHT}}">{{get_string "height" component}}</label><input type="text" class="{{CSS.INPUTHEIGHT}} input-mini" id="{{elementid}}_{{CSS.INPUTHEIGHT}}" size="4"/><input type="checkbox" class="{{CSS.INPUTCONSTRAIN}} sameline" id="{{elementid}}_{{CSS.INPUTCONSTRAIN}}"/><label for="{{elementid}}_{{CSS.INPUTCONSTRAIN}}">{{get_string "constrain" component}}</label></div><label class="sameline" for="{{elementid}}_{{CSS.INPUTALIGNMENT}}">{{get_string "alignment" component}}</label><select class="{{CSS.INPUTALIGNMENT}}" id="{{elementid}}_{{CSS.INPUTALIGNMENT}}">{{#each alignments}}<option value="{{value}}:{{name}};">{{get_string str ../component}}</option>{{/each}}</select><input type="hidden" class="{{CSS.INPUTCUSTOMSTYLE}}"/><br/><div class="mdl-align"><div class="{{CSS.IMAGEPREVIEWBOX}}"><img src="#" class="{{CSS.IMAGEPREVIEW}}" alt="" style="display: none;"/></div><button class="{{CSS.INPUTSUBMIT}}" type="submit">{{get_string "saveimage" component}}</button></div></form>',r='<img src="{{url}}" alt="{{alt}}" {{#if width}}width="{{width}}" {{/if}}{{#if height}}height="{{height}}" {{/if}}{{#if presentation}}role="presentation" {{/if}}style="{{alignment}}{{margin}}{{customstyle}}"{{#if classlist}}class="{{classlist}}" {{/if}}{{#if id}}id="{{id}}" {{/if}}/>';e.namespace("M.atto_image").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_selectedImage:null,_form:null,_rawImageDimensions:null,initializer:function(){this.addButton({icon:"e/insert_edit_image",callback:this._displayDialogue,tags:"img",tagMatchRequiresAll:!1}),this.editor.delegate("dblclick",this._displayDialogue,"img",this),this.editor.delegate("click",this._handleClick,"img",this),this.editor.on("drop",this._handleDragDrop,this)},_handleDragDrop:function(t){var n=this,a=this.get("host"),s=e.Handlebars.compile(r);a.saveSelection(),t=t._event;var l=t.dataTransfer&&t.dataTransfer.files&&t.dataTransfer.files.length;if(l&&/^image\//.test(t.dataTransfer.files[0].type)){var h=a.get("filepickeroptions").image,g=void 0===h.savepath?"/":h.savepath,m=new FormData,I=0,d="",c=new XMLHttpRequest,u="",T=Object.keys(h.repositories);t.preventDefault(),t.stopPropagation(),m.append("repo_upload_file",t.dataTransfer.files[0]),m.append("itemid",h.itemid);for(var N=0;N<T.length;N++)if("upload"===h.repositories[T[N]].type){m.append("repo_id",h.repositories[T[N]].id);break}return m.append("env",h.env),m.append("sesskey",M.cfg.sesskey),m.append("client_id",h.client_id),m.append("savepath",g),m.append("ctx_id",h.context.id),I=(new Date).getTime(),d="moodleimage_"+Math.round(1e5*Math.random())+"-"+I,a.focus(),a.restoreSelection(),u=s({url:M.util.image_url("i/loading_small","moodle"),alt:M.util.get_string("uploading",o),id:d}),a.insertContentAtFocusPoint(u),n.markUpdated(),c.onreadystatechange=function(){var t,a,o,l,r=n.editor.one("#"+d);if(4===c.readyState)if(200===c.status){if(t=JSON.parse(c.responseText)){if(t.error)return r&&r.remove(!0),new M.core.ajaxException(t);a=t,t.event&&"fileexists"===t.event&&(a=t.newfile),o=s({url:a.url,presentation:!0,classlist:i.RESPONSIVE}),l=e.Node.create(o),r?r.replace(l):n.editor.appendChild(l),n.markUpdated()}}else e.use("moodle-core-notification-alert",function(){new M.core.alert({message:M.util.get_string("servererror","moodle")})}),r&&r.remove(!0)},c.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload",!0),c.send(m),!1}},_handleClick:function(e){var t=e.target,i=this.get("host").getSelectionFromNode(t);this.get("host").getSelection()!==i&&this.get("host").setSelection(i)},_displayDialogue:function(){if(this._currentSelection=this.get("host").getSelection(),this._currentSelection!==!1){this._rawImageDimensions=null;var e=this.getDialogue({headerContent:M.util.get_string("imageproperties",o),width:"480px",focusAfterHide:!0,focusOnShowSelector:n.INPUTURL});e.set("bodyContent",this._getDialogueContent()).show()}},_loadPreviewImage:function(e){var t=new Image,n=this;t.onerror=function(){var e=n._form.one("."+i.IMAGEPREVIEW);e.setStyles({display:"none"}),n.getDialogue().centerDialogue()},t.onload=function(){var e,t,a,o,l;n._rawImageDimensions={width:this.width,height:this.height},e=n._form.one("."+i.INPUTWIDTH),t=e.get("value"),""===t&&(e.set("value",this.width),t=""+this.width),e=n._form.one("."+i.INPUTHEIGHT),a=e.get("value"),""===a&&(e.set("value",this.height),a=""+this.height),e=n._form.one("."+i.IMAGEPREVIEW),e.setAttribute("src",this.src),e.setStyles({display:"inline"}),e=n._form.one("."+i.INPUTCONSTRAIN),t.match(s.ISPERCENT)&&a.match(s.ISPERCENT)?e.set("checked",t===a):(0===this.width&&(this.width=1),0===this.height&&(this.height=1),o=Math.round(1e3*parseInt(t,10)/this.width),l=Math.round(1e3*parseInt(a,10)/this.height),e.set("checked",o===l)),n._autoAdjustSize(n),n.getDialogue().centerDialogue()},t.src=e},_getDialogueContent:function(){var t=e.Handlebars.compile(l),n=this.get("host").canShowFilepicker("image"),s=e.Node.create(t({elementid:this.get("host").get("elementid"),CSS:i,component:o,showFilepicker:n,alignments:a}));return this._form=s,this._applyImageProperties(this._form),this._form.one("."+i.INPUTURL).on("blur",this._urlChanged,this),this._form.one("."+i.IMAGEPRESENTATION).on("change",this._updateWarning,this),this._form.one("."+i.INPUTALT).on("change",this._updateWarning,this),this._form.one("."+i.INPUTWIDTH).on("blur",this._autoAdjustSize,this),this._form.one("."+i.INPUTHEIGHT).on("blur",this._autoAdjustSize,this,!0),this._form.one("."+i.INPUTCONSTRAIN).on("change",function(e){e.target.get("checked")&&this._autoAdjustSize(e)},this),this._form.one("."+i.INPUTURL).on("blur",this._urlChanged,this),this._form.one("."+i.INPUTSUBMIT).on("click",this._setImage,this),n&&this._form.one("."+i.IMAGEBROWSER).on("click",function(){this.get("host").showFilepicker("image",this._filepickerCallback,this)},this),s},_autoAdjustSize:function(e,t){t=t||!1;var n,a,o=this._form.one("."+i.INPUTWIDTH),l="width",r=this._form.one("."+i.INPUTHEIGHT),h="height",g=this._form.one("."+i.INPUTCONSTRAIN),m=o.get("value"),I=r.get("value"),d=this._form.one("."+i.IMAGEPREVIEW);if(this._rawImageDimensions)if(""===m&&(m=this._rawImageDimensions[l],o.set("value",m),m=o.get("value")),d.setStyles({width:null,height:null}),g.get("checked")){if(t){var c;c=o,o=r,r=c,c=l,l=h,h=c,c=m,m=I,I=c}m.match(s.ISPERCENT)?(I=m,n=parseInt(m,10),a=this._rawImageDimensions.width/100*n,d.setStyle("width",a),a=this._rawImageDimensions.height/100*n,d.setStyle("height",a)):(I=Math.round(m/this._rawImageDimensions[l]*this._rawImageDimensions[h]),t?d.setStyles({width:I,height:m}):d.setStyles({width:m,height:I})),r.set("value",I)}else m.match(s.ISPERCENT)?(n=parseInt(m,10),a=this._rawImageDimensions.width/100*n,d.setStyle("width",a+"px")):d.setStyle("width",m+"px"),I.match(s.ISPERCENT)?(n=parseInt(I,10),a=this._rawImageDimensions.height/100*n,d.setStyle("height",a+"px")):d.setStyle("height",I+"px")},_filepickerCallback:function(e){if(""!==e.url){var t=this._form.one("."+i.INPUTURL);t.set("value",e.url),this._form.one("."+i.INPUTWIDTH).set("value",""),this._form.one("."+i.INPUTHEIGHT).set("value",""),this._loadPreviewImage(e.url)}},_applyImageProperties:function(e){var t,n,s=this._getSelectedImageProperties(),o=e.one("."+i.IMAGEPREVIEW);if(s===!1){o.setStyle("display","none");for(t in a)a[t].isDefault===!0&&(n=a[t].value+":"+a[t].name+";",e.one("."+i.INPUTALIGNMENT).set("value",n));return void e.one("."+i.INPUTALIGNMENT).getDOMNode().options.remove(a.length-1)}s.align?(e.one("."+i.INPUTALIGNMENT).set("value",s.align),e.one("."+i.INPUTALIGNMENT).getDOMNode().options.remove(a.length-1)):e.one("."+i.INPUTALIGNMENT).set("value","style:customstyle;"),s.customstyle&&e.one("."+i.INPUTCUSTOMSTYLE).set("value",s.customstyle),s.width&&e.one("."+i.INPUTWIDTH).set("value",s.width),s.height&&e.one("."+i.INPUTHEIGHT).set("value",s.height),s.alt&&e.one("."+i.INPUTALT).set("value",s.alt),s.src&&(e.one("."+i.INPUTURL).set("value",s.src),this._loadPreviewImage(s.src)),s.presentation&&e.one("."+i.IMAGEPRESENTATION).set("checked","checked"),this._autoAdjustSize()},_getSelectedImageProperties:function(){var e,t,i,n,o,l,r,h={src:null,alt:null,width:null,height:null,align:"",presentation:!1},g=this.get("host").getSelectedNodes();if(g&&(g=g.filter("img")),g&&g.size()){l=g.item(0),this._selectedImage=l,n=l.getAttribute("style"),h.customstyle=n,n=n.replace(/ /g,""),t=l.getAttribute("width"),t.match(s.ISPERCENT)||(t=parseInt(t,10)),i=l.getAttribute("height"),i.match(s.ISPERCENT)||(i=parseInt(i,10)),0!==t&&(h.width=t),0!==i&&(h.height=i);for(e in a)if(o=a[e].value+":"+a[e].name+";",-1!==n.indexOf(o)&&(r="margin:"+a[e].margin+";",r=r.replace(/ /g,""),-1!==n.indexOf(r))){h.align=o;break}return h.src=l.getAttribute("src"),h.alt=l.getAttribute("alt")||"",h.presentation="presentation"===l.get("role"),h}return this._selectedImage=null,!1},_urlChanged:function(){var e=this._form.one("."+i.INPUTURL);""!==e.get("value")&&this._loadPreviewImage(e.get("value"))},_setImage:function(t){var n,o,l,h=this._form,g=h.one("."+i.INPUTURL).get("value"),m=h.one("."+i.INPUTALT).get("value"),I=h.one("."+i.INPUTWIDTH).get("value"),d=h.one("."+i.INPUTHEIGHT).get("value"),c=h.one("."+i.INPUTALIGNMENT).get("value"),u="",T=h.one("."+i.IMAGEPRESENTATION).get("checked"),N=h.one("."+i.INPUTCONSTRAIN).get("checked"),_="",p=[],S=this.get("host");if(t.preventDefault(),!this._updateWarning()){if(S.focus(),""!==g){if(this._selectedImage?S.setSelection(S.getSelectionFromNode(this._selectedImage)):S.setSelection(this._currentSelection),"style:customstyle;"===c)c="",_=h.one("."+i.INPUTCUSTOMSTYLE).get("value");else for(o in a)l=a[o].value+":"+a[o].name+";",c===l&&(u=" margin: "+a[o].margin+";");if(N&&p.push(i.RESPONSIVE),!I.match(s.ISPERCENT)&&isNaN(parseInt(I,10)))return void h.one("."+i.INPUTWIDTH).focus();if(!d.match(s.ISPERCENT)&&isNaN(parseInt(d,10)))return void h.one("."+i.INPUTHEIGHT).focus();var f=e.Handlebars.compile(r);n=f({url:g,alt:m,width:I,height:d,presentation:T,alignment:c,margin:u,customstyle:_,classlist:p.join(" ")}),this.get("host").insertContentAtFocusPoint(n),this.markUpdated()}this.getDialogue({focusAfterHide:null}).hide()}},_updateWarning:function(){var e=this._form,t=!0,n=e.one("."+i.INPUTALT).get("value"),a=e.one("."+i.IMAGEPRESENTATION).get("checked");return""!==n||a?(e.one("."+i.IMAGEALTWARNING).setStyle("display","none"),e.one("."+i.INPUTALT).setAttribute("aria-invalid",!1),e.one("."+i.IMAGEPRESENTATION).setAttribute("aria-invalid",!1),t=!1):(e.one("."+i.IMAGEALTWARNING).setStyle("display","block"),e.one("."+i.INPUTALT).setAttribute("aria-invalid",!0),e.one("."+i.IMAGEPRESENTATION).setAttribute("aria-invalid",!0),t=!0),this.getDialogue().centerDialogue(),t}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
